"use strict";jQuery(document).ready(function(){(function(b){b.fn.tagmeui=function(d){var c=new a(b(this),d);c.initTagField();return this};function a(f,e){var i=this,c=foswiki.getPreference("TOPIC"),d=foswiki.getPreference("WEB"),g=foswiki.getPreference("SYSTEMWEB"),h=foswiki.getPreference("SCRIPTURLPATH");this.caller=f;this.urlQuery=b.query;this.cloudQuery=this.urlQuery.copy();this.cloudQuery.SET("skin","text");this.cloudQuery.SET("contenttype","text/plain");this.cloudQuery.SET("section","cloud");this.tags=foswiki.getPreference("TagMePlugin.jquitags").split(",");if(!this.cloudQuery.get("qcallingweb")){this.cloudQuery.SET("qcallingweb",d)}this.settings={cloudSpinner:"#tagmejqtagbutton",cloudContainer:"#tagmejqcloud",cloudWeb:(function(){var j=i.cloudQuery.get("qcallingweb");if(!j){j=d}if(!i.cloudQuery.get("tpweb")){i.cloudQuery.SET("tpweb",j)}return j}()),cloudGetUrl:h+"/view/"+g+"/TagMeAjaxHelper",cloudUiJustThisWeb:"#tagmejqCheckboxJustThisWeb",cloudUiJustMe:"#tagmejqCheckboxJustMe",cloudModalOpts:{opacity:7,position:["70px",null],maxWidth:(document.width-50),persist:true,onShow:function(){b("#simplemodal-overlay").click(function(){b.modal.close()})}},taglistSpinner:"#tagmejqtagstatus",taglistContainer:"#tagmejqcontainer",taglistInputField:"#tagmejqinputfield",tagLinkUrl:h+"/view/"+g+"/TagMeSearch",tagLinkTitle:"Other topics with this tag",tagPostUrl:h+"/viewauth/"+d+"/"+c,autocompleteUrl:h+"/view/"+g+"/TagMeAjaxHelper?section=tagquery&contenttype=text/plain&skin=text",autocompleteOpts:{extraParams:{section:"tagquery",contenttype:"text/plain",skin:"text"},autoFill:true,matchCase:false,multiple:false,max:0,mustMatch:false}};b.extend(this.settings,e)}a.prototype.actOnMissingTag=function(e,h,c,f){var d=false,g=this;if(b.inArray(e,h)===-1){b(this.settings.taglistSpinner).addClass("spinning");b.post(this.settings.postUrl,{tpaction:c,tptag:e,qWeb:foswiki.getPreference("WEB"),qTopic:foswiki.getPreference("TOPIC"),contenttype:"text/plain",skin:"tagmejquiajax"},function(i){g.linkifyTagText(g.settings.taglistContainer);b(g.settings.taglistSpinner).removeClass("spinning");f(e)});d=true}return d};a.prototype.linkifyTagText=function(c){var d=this;b(c+" > form > div.jqTextboxListContainer > span:not(.linkified)").each(function(h,e){var j=b.query.copy(),g=b(e).text(),f=foswiki.getPreference("WEB");function i(k){if((typeof(k.lastChild)==="object")&&(k.lastChild!==null)){k.lastChild.data=""}return}j.SET("tag",g);j.SET("qcallingweb",f);j.SET("qweb",f);i(e);b(e).append('<a href="'+d.settings.tagLinkUrl+j.toString()+'" title="'+d.settings.tagLinkTitle+'">'+g+"</a>");b(e).addClass("linkified")});return};a.prototype.loadCloud=function(){var d=this;function c(){function e(g,f,h,i){if(b(h).is(":checked")===i){d.cloudQuery.SET(g,f)}else{d.cloudQuery=d.cloudQuery.remove(g)}}if(b("#simplemodal-container").width()>b(document).width()-50){b("#simplemodal-container").width(b(document).width()-50)}b(d.settings.cloudUiJustThisWeb).click(function(){e("tpweb",d.settings.cloudWeb,d.settings.cloudUiJustThisWeb,false);d.loadCloud()});b(d.settings.cloudUiJustMe).click(function(){e("tpuser","me",d.settings.cloudUiJustMe,true);d.loadCloud()})}b(this.settings.cloudSpinner).addClass("spinning");b(this.settings.cloudContainer).load(this.settings.cloudGetUrl+this.cloudQuery.toString(),function(){b(d.settings.cloudSpinner).removeClass("spinning");b(d.settings.cloudContainer).modal(d.settings.cloudModalOpts);c()})};a.prototype.initTagField=function(){var c=this;b(this.settings.taglistInputField).textboxlist({onSelect:function(e){var f=e.currentValues,d=false;b.each(f,function(h,g){if(c.actOnMissingTag(g,c.tags,"newtagsandadd",function(i){c.tags.push(i)})){d=true}});if(!d){b.each(c.tags,function(h,g){var i=foswiki.getPreference("TagMePlugin.remove");if((typeof(i)!=="undefined")&&(i==="all")){i="removeall"}else{i="remove"}if(!c.actOnMissingTag(g,f,i,function(j){c.tags.pop(j)})){c.linkifyTagText(c.settings.taglistContainer)}})}},onDeselect:function(e){var f=e.currentValues,d=false;b.each(f,function(h,g){if(c.actOnMissingTag(g,c.tags,"newtagsandadd",function(i){c.tags.push(i)})){d=true}});if(!d){b.each(c.tags,function(h,g){var i=foswiki.getPreference("TagMePlugin.remove");if((typeof(i)!=="undefined")&&(i==="all")){i="removeall"}else{i="remove"}if(!c.actOnMissingTag(g,f,i,function(j){c.tags.pop(j)})){c.linkifyTagText(c.settings.taglistContainer)}})}},autocomplete:this.settings.autocompleteUrl,autocompleteOpts:this.settings.autocompleteOpts});this.linkifyTagText(this.settings.taglistContainer);b(this.settings.cloudSpinner).click(function(){c.loadCloud()})}}(jQuery));$.fn.tagmeui()});